<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MNModeler</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="vendor/diagram-js/diagram-js.css">
  <link rel="stylesheet" href="vendor/bpmn-js/bpmn-js.css">
  <link rel="stylesheet" href="vendor/bpmn-js/bpmn-font/css/bpmn.css">
  <link rel="stylesheet" href="css/ppi-panel.css">
  <link rel="stylesheet" href="css/welcome-screen.css">
  <link rel="stylesheet" href="css/autosave-modals.css">
  <link rel="stylesheet" href="css/file-name-modal.css">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <!-- Pantalla de bienvenida -->
  <div class="welcome-screen" id="welcome-screen">
    <div class="welcome-content">
      <div class="logo" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <button class="back-to-welcome-btn" id="back-to-welcome-btn" title="Volver a la pantalla de bienvenida">
          <i class="fas fa-project-diagram"></i>
          <span>MNModeler</span>
        </button>
      </div>
      <p class="welcome-subtitle">Herramienta híbrida para modelado de procesos BPMN, PPINOT y RASCI</p>
      <div class="welcome-buttons">
        <button class="welcome-btn success" id="continue-diagram-btn" style="display:none">
          <i class="fas fa-play"></i>
          Continuar último diagrama
        </button>
        <button class="welcome-btn primary" id="new-diagram-btn">
          <i class="fas fa-plus"></i>
          Crear Nuevo Diagrama
        </button>
        <button class="welcome-btn secondary" id="open-diagram-btn">
          <i class="fas fa-folder-open"></i>
          Abrir Diagrama
        </button>
      </div>
    </div>
  </div>

  <!-- Contenedor del modelador -->
  <div class="modeler-container" id="modeler-container" style="display: none;">
    <header class="app-header" id="app-header">
      <div class="logo">
        <button class="back-to-welcome-btn" id="back-to-welcome-btn" title="Volver a la pantalla de bienvenida">
          <i class="fas fa-project-diagram"></i>
          <span>MNModeler</span>
        </button>
      </div>

      <div class="project-info" id="project-info">
        <div class="project-name-display">
          <span class="project-label">Proyecto:</span>
          <input 
            type="text" 
            class="project-name-input" 
            id="project-name-input" 
            value="Nuevo Diagrama" 
            placeholder="Nombre del proyecto"
            maxlength="50"
          />
        </div>
      </div>
      
      <div class="toolbar">
        <div class="tool-group">
          <button class="tool-btn" id="new-btn" title="Nuevo Diagrama">
            <i class="fas fa-plus"></i>
            Nuevo
          </button>
          <button class="tool-btn" id="open-btn" title="Abrir Diagrama">
            <i class="fas fa-folder-open"></i>
            Abrir
          </button>
          <button class="tool-btn" id="save-btn" title="Guardar Diagrama">
            <i class="fas fa-save"></i>
            Guardar
          </button>
          <button class="tool-btn panel-btn-new" id="panel-selector-btn" title="Gestionar paneles">
            <i class="fas fa-th-large"></i>
            <span class="panel-btn-text">Paneles</span>
          </button>
        </div>
        
        <input type="file" id="file-input" accept=".bpmn,.json,.xml" style="display: none;">

        <div class="save-success-indicator" id="save-success-indicator">
          <i class="fas fa-check"></i>
          <span>Guardado exitoso</span>
        </div>
      </div>

      <div class="restore-buttons" id="restore-buttons"></div>
    </header>

    <div class="workspace" id="workspace">
      <div class="panel-container" id="panel-container" data-layout="3"></div>
    </div>
  </div>

  <!-- Scripts principales -->
  <script>
    window.APP_CONFIG = {
      debug: false,
      autosaveInterval: 30000,
      maxUndoSteps: 50,
      defaultLayout: 3
    };

    window.currentProjectName = 'Nuevo Diagrama';
    let isOpenButtonClicked = false;

    function getServiceRegistry() {
      if (typeof window.serviceRegistry !== 'undefined') {
        return window.serviceRegistry;
      }
      try {
        if (typeof window.getServiceRegistry === 'function') {
          return window.getServiceRegistry();
        }
      } catch (_) {}
      return null;
    }

    function showErrorMessage(message) {
      console.error(message);
      alert(message);
    }

    async function newDiagramHandler() {
      try {
        const continueBtn = document.getElementById('continue-diagram-btn');
        if (continueBtn) continueBtn.style.display = 'none';

        const registry = getServiceRegistry();
        const manager = registry ? registry.get('localStorageAutoSaveManager') : null;
        if (manager && typeof manager.clearProjectState === 'function') {
          manager.clearProjectState();
        }

        const welcomeScreen = document.getElementById('welcome-screen');
        const modelerContainer = document.getElementById('modeler-container');
        if (welcomeScreen) welcomeScreen.style.display = 'none';
        if (modelerContainer) modelerContainer.style.display = 'block';

        window.currentProjectName = 'Nuevo Diagrama';
        const projectNameInput = document.getElementById('project-name-input');
        if (projectNameInput) projectNameInput.value = 'Nuevo Diagrama';
        localStorage.removeItem('projectName');

        if (typeof window.initModeler === 'function') {
          await window.initModeler();
        }
      } catch (e) {
        showErrorMessage('Error al iniciar nuevo diagrama: ' + e.message);
      }
    }

    async function downloadProjectHandler() {
      try {
        const projectNameInput = document.getElementById('project-name-input');
        const projectName = projectNameInput ? projectNameInput.value.trim() : '';
        const finalProjectName = projectName || 'Nuevo Diagrama';
        window.currentProjectName = finalProjectName;

        const registry = getServiceRegistry();
        const importManager = registry ? registry.get('ImportExportManager') : null;

        if (importManager) {
          if (typeof importManager.setProjectName === 'function') {
            importManager.setProjectName(finalProjectName);
          }
          await importManager.exportProject();
        } else {
          throw new Error('No se pudo acceder al gestor de exportación');
        }
      } catch (e) {
        showErrorMessage('Error al descargar proyecto: ' + e.message);
      }
    }

    async function openDiagramHandler() {
      if (isOpenButtonClicked) return;
      isOpenButtonClicked = true;
      
      try {
        if (typeof window.openFile === 'function') {
          const fileData = await window.openFile();

          const welcomeScreen = document.getElementById('welcome-screen');
          const modelerContainer = document.getElementById('modeler-container');
          if (welcomeScreen) welcomeScreen.style.display = 'none';
          if (modelerContainer) modelerContainer.style.display = 'block';

          if (fileData.type === 'project') {
            const registry = getServiceRegistry();
            const importManager = registry ? registry.get('ImportExportManager') : null;
            if (importManager) {
              await importManager.importAllProjectData(fileData.data);
            }
          } else if (fileData.type === 'bpmn' && window.modeler) {
            if (typeof window.modeler.importXML === 'function') {
              await window.modeler.importXML(fileData.content);
            }
          }
        } else {
          const fileInput = document.getElementById('file-input');
          if (fileInput) fileInput.click();
        }
      } catch (e) {
        showErrorMessage('Error al abrir diagrama: ' + e.message);
      } finally {
        isOpenButtonClicked = false;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const projectNameInput = document.getElementById('project-name-input');
      if (projectNameInput) {
        projectNameInput.addEventListener('input', function() {
          window.currentProjectName = this.value || 'Nuevo Diagrama';
          localStorage.setItem('projectName', window.currentProjectName);
          try {
            const registry = getServiceRegistry();
            const importManager = registry ? registry.get('ImportExportManager') : null;
            if (importManager && typeof importManager.setProjectName === 'function') {
              importManager.setProjectName(window.currentProjectName);
            }
          } catch (_) {}
        });

        projectNameInput.addEventListener('keydown', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            this.blur();
            window.currentProjectName = this.value || 'Nuevo Diagrama';
            localStorage.setItem('projectName', window.currentProjectName);
          }
        });
      }

      document.getElementById('new-btn')?.addEventListener('click', newDiagramHandler);
      document.getElementById('open-btn')?.addEventListener('click', openDiagramHandler);
      document.getElementById('save-btn')?.addEventListener('click', downloadProjectHandler);

      document.getElementById('back-to-welcome-btn')?.addEventListener('click', function() {
        const welcomeScreen = document.getElementById('welcome-screen');
        const modelerContainer = document.getElementById('modeler-container');
        if (welcomeScreen && modelerContainer) {
          welcomeScreen.style.display = 'flex';
          modelerContainer.style.display = 'none';
        }
      });

      const fileInput = document.getElementById('file-input');
      if (fileInput) {
        fileInput.addEventListener('change', async function(event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async function(e) {
            const content = e.target.result;
            const fileData = {
              type: file.name.endsWith('.mmproject') ? 'project' : 'bpmn',
              content: content,
              data: file.name.endsWith('.mmproject') ? JSON.parse(content) : null,
              fileName: file.name
            };
            const welcomeScreen = document.getElementById('welcome-screen');
            const modelerContainer = document.getElementById('modeler-container');
            if (welcomeScreen) welcomeScreen.style.display = 'none';
            if (modelerContainer) modelerContainer.style.display = 'block';
            if (fileData.type === 'project') {
              const registry = getServiceRegistry();
              const importManager = registry ? registry.get('ImportExportManager') : null;
              if (importManager) await importManager.importAllProjectData(fileData.data);
            } else if (fileData.type === 'bpmn' && window.modeler) {
              if (typeof window.modeler.importXML === 'function') {
                await window.modeler.importXML(fileData.content);
              }
            }
          };
          reader.readAsText(file);
          event.target.value = '';
        });
      }
    });
  </script>
  
  <script src="bundle.js"></script>
</body>
</html>
